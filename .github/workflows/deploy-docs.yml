name: Deploy docs

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Importante para pegar todo o histÃ³rico

      - uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install
          git update-index --assume-unchanged package-lock.json

      - name: Build all packages
        run: |
          npm run build --workspace=@ignite-ui/tokens
          npm run build --workspace=@ignite-ui/react

      - name: Update Storybook imports
        run: |
          sed -i 's|from "/tokens/dist"|from "../../../tokens/dist"|g' packages/docs/src/pages/tokens/font-sizes.mdx
          sed -i 's|from "@carol23-ignite-ui/tokens"|from "../../../tokens/dist"|g' packages/docs/src/pages/tokens/font-sizes.mdx

      - name: Configure Storybook
        run: |
          cat > packages/docs/.storybook/main.js << 'EOF'
          import { join, dirname } from 'path';
          export default {
            stories: ['../src/pages/**/*.stories.mdx', '../src/stories/**/*.stories.tsx'],
            addons: ['@storybook/addon-links', '@storybook/addon-essentials', '@storybook/addon-interactions'],
            framework: '@storybook/react-vite',
            core: { builder: '@storybook/builder-vite' },
            viteFinal: async (config) => {
              config.resolve.alias = { 
                ...config.resolve.alias, 
                '@ignite-ui/tokens': join(dirname(require.resolve('@ignite-ui/tokens')), 
                '@ignite-ui/react': join(dirname(require.resolve('@ignite-ui/react'))
              };
              return config;
            },
          };
          EOF

      - name: Build Storybook
        working-directory: ./packages/docs
        run: npm run build-storybook

      - name: Deploy Storybook
        working-directory: ./packages/docs
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          npm run deploy-storybook -- --ci --existing-output-dir=storybook-static
